# 产品需求文档 (PRD) - 问题定位助手

**文档版本**: 1.0
**创建日期**: 2026-02-03
**项目类型**: 0-1 新项目
**作者**: Product Manager
**状态**: 待审核

---

## 1. 产品概述

### 1.1 产品名称
问题定位助手 (Problem Diagnosis Assistant)

### 1.2 产品定位
智能化问题诊断系统，将完全依赖人工的问题定位流程自动化和智能化，显著缩短问题定位时间，降低新员工上手难度。

### 1.3 目标用户
- 技术支持人员
- 运维人员
- 开发人员
- 新入职员工

### 1.4 核心价值
- **效率提升**: 将问题定位时间从数小时/数天缩短至1分钟内
- **降低门槛**: 新员工快速上手，无需数月培训
- **自动化**: 自动生成问题报告，减少重复劳动
- **智能化**: AI辅助代码理解和根因分析

---

## 2. 问题陈述

### 2.1 当前痛点
当前问题定位完全依赖人工，存在以下问题：

1. **日志收集耗时**: 需要SSH登录多台服务器手动下载日志
2. **多模块关联困难**: 涉及5个以上模块，需要反复对比多个模块日志
3. **日志分散**: 日志分散在本地文件、多个服务器、客户提供等多个位置
4. **代码理解困难**: 30+模块，每个40K+行代码，新员工难以快速理解
5. **需要远程调试**: 部分问题需要查看代码和远程调试
6. **报告编写重复**: 需要向客户解释问题并输出报告，重复劳动

### 2.2 影响
- 问题定位周期长，影响客户满意度
- 新员工培养成本高
- 技术支持人员工作负担重

---

## 3. 成功指标

| 指标 | 当前状态 | 目标状态 | 优先级 |
|------|---------|---------|--------|
| 问题定位时间 | 数小时到数天 | < 1分钟 (80%案例) | P0 |
| 根因定位准确率 | 依赖人工经验 | > 80% | P0 |
| 新员工独立定位能力 | 需要数月培训 | 1小时培训即可使用 | P0 |
| 报告生成时间 | 手动编写 | < 30秒自动生成 | P0 |
| 系统可用性 | N/A | > 99% | P0 |

---

## 4. 功能需求

### 4.1 核心功能 (P0 - 必须实现)

#### F1: 日志聚合系统

**功能描述**
自动收集和聚合多个模块的日志，支持多种来源和格式。

**详细需求**

1. **日志来源支持**
   - SSH连接服务器自动下载日志
   - 手动上传本地日志文件（支持拖拽）
   - 导入客户提供的日志

2. **日志格式支持**
   - JSON格式
   - 纯文本格式
   - 结构化日志

3. **日志解析和标准化**
   - 自动识别日志格式
   - 提取时间戳、日志级别、模块名、消息内容
   - 统一存储格式

4. **日志关联**
   - 基于时间戳关联多模块日志
   - 基于请求ID/事务ID关联（如果存在）
   - 支持时间范围筛选

**验收标准**
- [ ] 能够通过SSH连接至少5个服务器并下载日志
- [ ] 支持上传和解析JSON、文本、结构化日志三种格式
- [ ] 能够按时间线展示多模块日志（至少5个模块并行展示）
- [ ] 日志解析准确率 > 95%（时间戳、级别、模块名提取正确）
- [ ] 支持处理GB级日志文件（至少1GB）
- [ ] 日志上传响应时间 < 5秒（100MB文件）

---

#### F2: 智能日志分析

**功能描述**
使用AI分析日志，识别异常模式和关联关系，定位根本原因。

**详细需求**

1. **异常检测**
   - 识别ERROR、EXCEPTION、FATAL等错误日志
   - 检测异常堆栈信息
   - 识别性能异常（超时、慢查询等）

2. **关联分析**
   - 分析跨模块的调用链路
   - 识别因果关系（A模块错误导致B模块失败）
   - 时间序列分析（问题发生前后的事件）

3. **根因定位**
   - 基于日志内容推断根本原因
   - 提供可能的问题点列表（按可能性排序）
   - 关联到具体的代码模块和文件

**验收标准**
- [ ] 能够识别所有ERROR级别及以上的日志
- [ ] 能够提取完整的异常堆栈信息
- [ ] 能够生成跨模块调用链路图（可视化展示）
- [ ] 根因定位准确率 > 80%（与人工分析结果对比）
- [ ] 分析响应时间 < 1分钟（处理1GB日志）
- [ ] 提供至少3个可能的问题点，按可能性排序

---

#### F3: 代码理解系统

**功能描述**
提供代码上下文、解释和业务流程说明，帮助快速理解代码。

**详细需求**

1. **代码索引**
   - 索引所有30+模块的代码（支持Java/Spring、Python、C++、Node.js）
   - 支持按文件、类、函数搜索
   - 建立代码调用关系图

2. **代码解释**
   - 针对问题相关的代码提供AI解释
   - 解释函数功能、参数含义、返回值
   - 标注关键逻辑和潜在问题点

3. **业务流程说明**
   - 基于代码分析生成业务流程图
   - 展示模块间的交互关系
   - 标注数据流向

4. **关键代码推荐**
   - 根据问题类型推荐需要查看的代码位置
   - 提供代码文件路径和行号
   - 高亮显示可疑代码段

**验收标准**
- [ ] 完成所有模块代码索引（1.2M+行代码）
- [ ] 首次索引时间 < 10分钟
- [ ] 能够根据日志错误定位到具体代码文件和行号
- [ ] 生成的代码解释清晰易懂（用户可理解度 > 80%）
- [ ] 业务流程图准确反映实际调用关系
- [ ] 支持Java、Python、C++、Node.js四种语言
- [ ] 代码搜索响应时间 < 2秒

---

#### F4: 问题报告生成

**功能描述**
自动生成问题分析报告和改进建议，支持多种格式导出。

**详细需求**

1. **报告内容**
   - 问题概述（问题类型、影响范围、发生时间）
   - 问题现象（用户反馈、日志表现）
   - 根因分析（技术原因、代码位置）
   - 解决方案建议（临时方案、根本解决方案）
   - 改进建议（代码优化、监控增强、流程改进）

2. **报告格式**
   - 支持导出为PDF、Markdown格式
   - 包含图表（日志时间线、调用链路图、流程图）
   - 支持自定义模板

3. **客户友好**
   - 技术术语解释
   - 非技术人员可读的问题说明
   - 影响评估和后续行动建议

**验收标准**
- [ ] 报告包含所有必需章节（概述、现象、根因、解决方案、改进建议）
- [ ] 支持导出为PDF和Markdown两种格式
- [ ] 报告生成时间 < 30秒
- [ ] 报告内容准确完整（包含所有分析结果）
- [ ] 图表正确渲染（时间线、调用链路图、流程图）
- [ ] 技术术语有解释说明

---

#### F5: Web用户界面

**功能描述**
提供直观的Web界面进行问题诊断和结果展示。

**详细需求**

1. **工单集成**
   - 从工单系统导入问题信息
   - 关联工单ID
   - 显示工单基本信息

2. **日志上传/配置**
   - 拖拽上传日志文件
   - 配置SSH服务器连接信息
   - 选择时间范围和模块

3. **分析结果展示**
   - 日志时间线视图（多模块并行展示）
   - 异常高亮显示
   - 调用链路可视化
   - 代码片段展示（带语法高亮）
   - 业务流程图展示

4. **报告管理**
   - 查看历史报告
   - 编辑和导出报告
   - 分享报告链接

**验收标准**
- [ ] 界面响应流畅（页面加载时间 < 2秒）
- [ ] 支持拖拽上传文件（至少100MB）
- [ ] 日志时间线清晰易读（支持缩放和滚动）
- [ ] 所有图表正确渲染（时间线、调用链路、流程图）
- [ ] 代码语法高亮正确（Java、Python、C++、Node.js）
- [ ] 支持浏览器：Chrome、Firefox、Edge最新版本
- [ ] 响应式设计（支持1920x1080及以上分辨率）

---

#### F6: 权限管理

**功能描述**
控制不同角色的访问权限，确保系统安全。

**详细需求**

1. **角色定义**
   - 管理员：所有权限
   - 普通用户：查看和分析权限，无配置权限

2. **权限控制**
   - 代码访问权限（敏感代码模块限制）
   - 服务器连接权限
   - 报告导出权限

3. **审计日志**
   - 记录所有操作（谁、何时、做了什么）
   - 支持审计日志查询和导出

**验收标准**
- [ ] 实现管理员和普通用户两种角色
- [ ] 权限控制生效（普通用户无法访问受限功能）
- [ ] 审计日志完整记录所有操作
- [ ] 审计日志包含用户、时间、操作类型、操作对象
- [ ] 会话超时机制（30分钟无操作自动登出）
- [ ] SSH密码加密存储

---

### 4.2 增强功能 (P1 - 应该实现)

#### F7: 解决方案知识库

**功能描述**
存储历史问题和解决方案，提供相似问题推荐。

**详细需求**
- 存储历史问题和解决方案
- 相似问题推荐（基于日志特征匹配）
- 解决方案有效性反馈

**验收标准**
- [ ] 能够存储和检索历史问题
- [ ] 相似问题推荐准确率 > 70%
- [ ] 支持用户反馈解决方案有效性

---

#### F8: 实时监控集成

**功能描述**
接入监控系统告警，自动触发问题诊断。

**详细需求**
- 接入监控系统告警
- 自动触发问题诊断
- 主动问题发现

**验收标准**
- [ ] 能够接收监控系统告警
- [ ] 自动触发诊断流程
- [ ] 告警响应时间 < 1分钟

---

### 4.3 未来考虑 (P2 - 可以延后)

#### F9: 远程调试支持
- 集成远程调试工具
- 断点建议
- 变量追踪

#### F10: 自动修复建议
- 生成修复代码
- 自动化测试验证
- 一键部署修复

---

## 5. 非功能需求

### 5.1 性能要求
- 日志分析响应时间: < 1分钟
- 代码索引时间: < 10分钟（首次）
- 报告生成时间: < 30秒
- 界面加载时间: < 2秒
- 支持GB级日志文件（至少1GB）
- 支持并发用户: 10+

### 5.2 可用性要求
- 系统可用性: 99%
- 数据备份: 每日自动备份
- 故障恢复时间: < 1小时

### 5.3 安全要求
- SSH连接加密
- 密码安全存储（加密）
- 会话超时机制（30分钟）
- 操作审计日志
- 敏感代码访问控制

### 5.4 兼容性要求
- 浏览器支持: Chrome、Firefox、Edge（最新版本）
- 代码语言支持: Java、Python、C++、Node.js
- 日志格式支持: JSON、文本、结构化日志

### 5.5 可维护性要求
- 代码注释覆盖率: 关键逻辑必须有中文注释
- 错误日志: 所有异常必须记录日志
- 配置外部化: 所有配置项可通过配置文件修改

---

## 6. 用户场景

### 场景1: 新员工首次使用
**角色**: 新入职技术支持人员
**目标**: 快速定位客户报障问题
**步骤**:
1. 登录系统
2. 创建新工单或导入现有工单
3. 上传客户提供的日志文件
4. 点击"开始分析"
5. 查看分析结果（异常日志、调用链路、根因分析）
6. 查看推荐的代码位置和解释
7. 生成并导出问题报告
8. 发送报告给客户

**预期结果**: 30分钟内完成问题定位和报告生成

---

### 场景2: 多服务器日志分析
**角色**: 运维人员
**目标**: 分析分布式系统问题
**步骤**:
1. 配置5个服务器的SSH连接信息
2. 选择时间范围（如：2026-02-03 10:00-11:00）
3. 选择相关模块（如：API网关、订单服务、支付服务、数据库、消息队列）
4. 系统自动下载并聚合日志
5. 查看时间线视图，识别异常时间点
6. 查看调用链路图，识别故障传播路径
7. 查看根因分析结果
8. 生成报告

**预期结果**: 5分钟内完成日志收集和分析

---

### 场景3: 代码理解辅助
**角色**: 开发人员
**目标**: 理解陌生模块的代码逻辑
**步骤**:
1. 在分析结果中看到错误发生在某个模块
2. 点击代码位置链接
3. 查看代码片段和AI解释
4. 查看业务流程图，理解模块间交互
5. 查看调用关系图，理解函数调用链
6. 根据推荐查看相关代码文件

**预期结果**: 10分钟内理解陌生模块的核心逻辑

---

## 7. 约束条件

### 7.1 技术约束
- 必须使用自定义OpenAI兼容接口（不能使用公有云LLM服务）
- 代码索引必须支持Java、Python、C++、Node.js四种语言
- 系统必须支持离线部署（内网环境）

### 7.2 业务约束
- 第一版开发周期: 2-3周
- 必须支持现有30+模块的代码
- 必须兼容现有日志格式

### 7.3 安全约束
- 敏感代码模块必须有访问控制
- SSH密码必须加密存储
- 所有操作必须有审计日志

---

## 8. 明确不做的事情 (Out of Scope)

第一版明确不包含以下功能：

- ❌ 与现有日志平台集成（如ELK、Splunk）
- ❌ 移动端应用
- ❌ 实时日志流处理
- ❌ 自动化修复和部署
- ❌ 多租户支持
- ❌ 国际化（i18n）
- ❌ 复杂的工作流引擎
- ❌ 机器学习模型训练（使用现成的LLM）
- ❌ 与第三方工单系统集成（第一版手动导入）

---

## 9. 待确认问题

在进入架构设计阶段前，需要确认以下问题：

### 9.1 LLM选择
**问题**: 使用哪个LLM模型？
**选项**:
- OpenAI GPT-4
- Claude
- 其他自定义模型

**需要考虑**: 成本、延迟、准确率、API兼容性

---

### 9.2 代码索引策略
**问题**: 代码索引采用什么策略？
**选项**:
- 全量索引（启动时索引所有代码）
- 按需索引（使用时才索引相关模块）
- 增量索引（定期更新变更的代码）

**需要考虑**: 索引时间、存储空间、查询性能

---

### 9.3 日志存储策略
**问题**: 日志保留多久？如何清理旧数据？
**选项**:
- 保留30天
- 保留90天
- 保留1年

**需要考虑**: 存储成本、查询性能、合规要求

---

### 9.4 业务流程图生成
**问题**: 业务流程图如何生成？
**选项**:
- 完全自动化（基于代码分析）
- 半自动化（需要人工标注关键节点）
- 手动配置（预先配置流程模板）

**需要考虑**: 准确性、维护成本、灵活性

---

### 9.5 SSH密钥管理
**问题**: 如何安全存储和管理多个服务器的SSH密钥？
**选项**:
- 数据库加密存储
- 使用密钥管理服务（如HashiCorp Vault）
- 每次使用时要求用户输入

**需要考虑**: 安全性、易用性、运维成本

---

## 10. 验收标准总结

系统上线前必须满足以下条件：

### 10.1 功能完整性
- [ ] 所有P0功能正常工作
- [ ] 所有验收标准通过

### 10.2 性能达标
- [ ] 问题定位时间 < 1分钟（80%的案例）
- [ ] 日志分析响应时间 < 1分钟
- [ ] 报告生成时间 < 30秒
- [ ] 界面加载时间 < 2秒

### 10.3 准确性
- [ ] 根因定位准确率 > 80%
- [ ] 日志解析准确率 > 95%

### 10.4 易用性
- [ ] 新员工经过1小时培训即可使用
- [ ] 界面直观易懂

### 10.5 稳定性
- [ ] 系统可用性 > 99%
- [ ] 无严重Bug

---

## 11. 后续迭代计划

### V1.1 (第4-6周)
- 解决方案知识库
- 相似问题推荐
- 用户反馈机制

### V1.2 (第7-9周)
- 实时监控集成
- 主动问题发现
- 性能优化

### V2.0 (第10-12周)
- 远程调试支持
- 自动修复建议
- 高级分析功能

---

## 附录

### A. 术语表
- **根因**: 导致问题发生的根本原因
- **调用链路**: 模块间的调用关系和顺序
- **异常堆栈**: 程序异常时的函数调用栈信息
- **代码索引**: 对代码进行结构化分析和存储，便于快速检索

### B. 参考资料
- 现有问题定位流程文档
- 现有日志格式规范
- 现有代码仓库结构

---

**文档结束**
